---
- name: Check if repository exists
  stat:
    path: "{{ app_dir }}/.git"
  register: repo_exists

- name: Clone application repository
  git:
    repo: "https://github.com/{{ github_username }}/{{ github_repo }}.git"
    dest: "{{ app_dir }}"
    version: "{{ github_branch }}"
    force: yes
  when: not repo_exists.stat.exists
  register: git_clone

- name: Pull latest changes
  git:
    repo: "https://github.com/{{ github_username }}/{{ github_repo }}.git"
    dest: "{{ app_dir }}"
    version: "{{ github_branch }}"
    force: yes
  when: repo_exists.stat.exists
  register: git_pull

- name: Ensure app directory ownership
  file:
    path: "{{ app_dir }}"
    owner: ubuntu
    group: ubuntu
    recurse: yes

- name: Create .env file
  copy:
    dest: "{{ app_dir }}/.env"
    content: |
      JWT_SECRET={{ jwt_secret }}
      NODE_ENV=production
    mode: '0644'
    owner: ubuntu
    group: ubuntu

- name: Check if docker-compose.yml changed
  set_fact:
    compose_changed: "{{ git_clone.changed or git_pull.changed }}"

- name: Stop existing containers
  command: docker-compose down -v
  args:
    chdir: "{{ app_dir }}"
  ignore_errors: yes

- name: Remove dangling images
  command: docker image prune -f
  ignore_errors: yes

- name: Build and start Docker containers
  command: docker-compose up -d --build --force-recreate --remove-orphans
  args:
    chdir: "{{ app_dir }}"
  register: compose_up

- name: Wait for containers to start
  pause:
    seconds: 15

- name: Show Docker Compose output
  debug:
    var: compose_up.stdout_lines

- name: Check running containers
  command: docker-compose ps
  args:
    chdir: "{{ app_dir }}"
  register: compose_ps

- name: Display running containers
  debug:
    var: compose_ps.stdout_lines

- name: Wait for services to be healthy
  wait_for:
    port: "{{ item }}"
    host: localhost
    delay: 10
    timeout: 120
  loop:
    - 80
    - 443
  ignore_errors: yes

- name: Display deployment status
  debug:
    msg: "Application deployed successfully at https://hngtech.name.ng"
